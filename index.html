<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Logistic Regression Solver</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #f57c00;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    h1 {
      padding: 20px;
      margin: 0;
      font-size: 28px;
    }
    .container {
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      flex: 1;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.4);
      overflow-x: auto;
    }
    .card input, .card textarea {
      width: 100%;
      margin: 8px 0;
      padding: 8px;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 5px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #f57c00;
      color: white;
    }
    button:hover {
      background: #e56e00;
    }
    .weights-table, .pred-table {
      margin-top: 10px;
      width: 100%;
      border-collapse: collapse;
    }
    .weights-table th, .weights-table td,
    .pred-table th, .pred-table td {
      border: 1px solid #444;
      padding: 5px;
      text-align: center;
    }
    #copyButton, #copyPreds {
      margin-top: 10px;
      background: #333;
      color: #f57c00;
    }
    #plot {
      margin-top: 20px;
      height: 400px;
    }
  </style>
</head>
<body>
  <h1>Logistic Regression Solver</h1>
  <div class="container">
    <!-- Left side: controls -->
    <div class="card">
      <label><input type="radio" name="inputType" value="file" checked> Upload CSV file</label><br>
      <label><input type="radio" name="inputType" value="paste"> Paste CSV data</label>
      <div id="fileInput"><input type="file" id="csvFile"></div>
      <div id="pasteInput" style="display:none;">
        <textarea id="csvText" rows="10" placeholder="Paste CSV data here"></textarea>
      </div>
      <input type="number" id="epochs" placeholder="Epochs" value="200">
      <input type="number" step="0.01" id="learningRate" placeholder="Learning rate (α)" value="0.1">
      <input type="number" id="batchSize" placeholder="Batch size (0 = full)" value="0">
      <label><input type="checkbox" id="standardize"> Standardize features</label><br>
      <button id="startBtn">Start Training</button>
      <button id="resetBtn">Reset</button>
      <p id="progress">Progress: Not started</p>
    </div>

    <!-- Right side: results -->
    <div class="card">
      <h3>Weights (w0 = bias)</h3>
      <table class="weights-table" id="weightsTable">
        <tr><th>Index</th><th>Weight</th></tr>
      </table>
      <button id="copyButton">Copy Weights</button>

      <h3>Predictions (per data point)</h3>
      <table class="pred-table" id="predTable">
        <tr><th>x</th><th>y (true)</th><th>ŷ (pred)</th></tr>
      </table>
      <button id="copyPreds">Copy Predictions</button>

      <div id="plot"></div>
    </div>
  </div>

<script>
document.querySelectorAll("input[name='inputType']").forEach(r => {
  r.addEventListener("change", () => {
    document.getElementById("fileInput").style.display = r.value === "file" ? "block" : "none";
    document.getElementById("pasteInput").style.display = r.value === "paste" ? "block" : "none";
  });
});

function parseCSV(text) {
  const rows = text.trim().split("\n").map(r => r.split(","));
  rows.shift(); // remove header
  const X = rows.map(r => [parseFloat(r[0])]);
  const y = rows.map(r => parseFloat(r[1]));
  return {X, y};
}

function sigmoid(z) {
  return 1 / (1 + Math.exp(-z));
}

function logisticRegression(X, y, epochs, lr, batchSize, standardize, callback) {
  let n = X.length;
  let d = X[0].length;
  let w = Array(d+1).fill(0);

  let mean = [], std = [];
  if (standardize) {
    for (let j=0;j<d;j++) {
      mean[j] = X.map(r=>r[j]).reduce((a,b)=>a+b,0)/n;
      std[j] = Math.sqrt(X.map(r=>(r[j]-mean[j])**2).reduce((a,b)=>a+b,0)/n);
    }
    X = X.map(r => r.map((val,j)=>(val-mean[j])/std[j]));
  }

  let losses = [];
  for (let epoch=0;epoch<epochs;epoch++) {
    let indices = [...Array(n).keys()];
    if (batchSize>0) indices = indices.sort(()=>Math.random()-0.5);

    for (let i=0;i<n;i+=batchSize||n) {
      let batchIdx = indices.slice(i,i+(batchSize||n));
      let grad = Array(d+1).fill(0);
      let loss = 0;
      for (let idx of batchIdx) {
        let xi = [1,...X[idx]];
        let yi = y[idx];
        let z = xi.reduce((a,b,j)=>a+w[j]*b,0);
        let pi = sigmoid(z);
        loss += - (yi*Math.log(pi+1e-10)+(1-yi)*Math.log(1-pi+1e-10));
        for (let j=0;j<grad.length;j++) grad[j] += (pi-yi)*xi[j];
      }
      for (let j=0;j<w.length;j++) w[j] -= lr*grad[j]/batchIdx.length;
      losses.push(loss/batchIdx.length);
    }
    callback(epoch, w, losses);
  }
  return {w, losses, X};
}

document.getElementById("startBtn").onclick = async () => {
  let epochs = parseInt(document.getElementById("epochs").value);
  let lr = parseFloat(document.getElementById("learningRate").value);
  let batchSize = parseInt(document.getElementById("batchSize").value);
  let standardize = document.getElementById("standardize").checked;

  let dataText = "";
  if (document.querySelector("input[name='inputType']:checked").value==="file") {
    let file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Upload a CSV file first");
    dataText = await file.text();
  } else {
    dataText = document.getElementById("csvText").value;
  }

  let {X,y} = parseCSV(dataText);

  document.getElementById("progress").innerText = "Training...";
  let table = document.getElementById("weightsTable");
  table.innerHTML = "<tr><th>Index</th><th>Weight</th></tr>";

  let {w, losses, X: Xproc} = logisticRegression(X,y,epochs,lr,batchSize,standardize,(epoch,w,losses)=>{
    if (epoch%10===0) {
      document.getElementById("progress").innerText = `Epoch ${epoch+1}/${epochs}`;
    }
  });

  // show weights
  w.forEach((wi,i)=>{
    let row = table.insertRow();
    row.insertCell(0).innerText = "w"+i;
    row.insertCell(1).innerText = wi.toFixed(5);
  });

  // predictions per data
  let predTable = document.getElementById("predTable");
  predTable.innerHTML = "<tr><th>x</th><th>y (true)</th><th>ŷ (pred)</th></tr>";
  for (let i=0;i<X.length;i++) {
    let xi = [1,...Xproc[i]];
    let pi = sigmoid(xi.reduce((a,b,j)=>a+w[j]*b,0));
    let row = predTable.insertRow();
    row.insertCell(0).innerText = X[i][0].toFixed(4);
    row.insertCell(1).innerText = y[i];
    row.insertCell(2).innerText = pi.toFixed(5);
  }

  // plot loss
  Plotly.newPlot("plot",[{y:losses,mode:"lines",line:{color:"#f57c00"}}],
    {title:"Training Loss",xaxis:{title:"Step"},yaxis:{title:"Loss"},
     paper_bgcolor:"#1e1e1e",plot_bgcolor:"#1e1e1e",font:{color:"#f57c00"}});
  
  document.getElementById("progress").innerText = "Training completed!";
};

// copy weights
document.getElementById("copyButton").onclick = () => {
  let rows = [...document.querySelectorAll("#weightsTable tr")].slice(1);
  let text = rows.map(r=>r.cells[0].innerText+"="+r.cells[1].innerText).join(", ");
  navigator.clipboard.writeText(text);
  alert("Weights copied:\n"+text);
};

// copy predictions
document.getElementById("copyPreds").onclick = () => {
  let rows = [...document.querySelectorAll("#predTable tr")].slice(1);
  let text = rows.map(r=>`x=${r.cells[0].innerText}, y=${r.cells[1].innerText}, y_hat=${r.cells[2].innerText}`).join("\n");
  navigator.clipboard.writeText(text);
  alert("Predictions copied to clipboard!");
};

// reset
document.getElementById("resetBtn").onclick = () => {
  document.getElementById("weightsTable").innerHTML = "<tr><th>Index</th><th>Weight</th></tr>";
  document.getElementById("predTable").innerHTML = "<tr><th>x</th><th>y (true)</th><th>ŷ (pred)</th></tr>";
  Plotly.purge("plot");
  document.getElementById("progress").innerText = "Not started";
};
</script>
</body>
</html>
